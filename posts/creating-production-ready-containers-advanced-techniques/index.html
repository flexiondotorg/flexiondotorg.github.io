<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="Blog, Podcasts, Live Streams and Videos about Linux and Open Source with a focus on Ubuntu, Debian and NixOS."><meta name=author content="Martin Wimpress"><meta name=keywords content="Docker,DevOps,docker-slim,SlimToolKit,Alpine,Docker Compose,Distroless,Buildpacks,Multi-Stage Builds"><meta name=twitter:card content="summary"><meta name=twitter:title content="Creating Production-Ready Containers - Advanced Techniques"><meta name=twitter:description content="Advanced techniques for production-ready container best practice"><meta name=twitter:site content="@m_wimpress"><meta name=msapplication-TileColor content="#00aba9"><meta name=theme-color content="#ffffff"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=stylesheet href=/css/style.css type=text/css media=print onload='this.media="all"'><link rel=stylesheet href=/css/fonts.css type=text/css media=print onload='this.media="all"'><link rel=stylesheet href=/css/syntax.css type=text/css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css type=text/css media=print onload='this.media="all"' crossorigin=anonymous referrerpolicy=no-referrer integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="><noscript><link rel=stylesheet href=/css/style.css type=text/css><link rel=stylesheet href=/css/fonts.css type=text/css><link rel=stylesheet href=/css/syntax.css type=text/css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css type=text/css crossorigin=anonymous referrerpolicy=no-referrer integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="></noscript><link rel=canonical href=https://wimpysworld.com/posts/creating-production-ready-containers-advanced-techniques/><title>Creating Production-Ready Containers - Advanced Techniques</title></head><body><nav class="navbar navbar-expand-lg bg-secondary text-uppercase fixed-top" id=mainNav><div class=container><a class=navbar-brand href=/>Wimpy's World</a>
<button class="navbar-toggler text-uppercase font-weight-bold bg-primary text-white rounded" type=button data-bs-toggle=collapse data-bs-target=#navbarResponsive aria-controls=navbarResponsive aria-expanded=false aria-label="Toggle navigation">
Menu<em class="fas fa-bars"></em></button><div class="collapse navbar-collapse" id=navbarResponsive><ul class="navbar-nav ms-auto"><li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded" href=https://wimpysworld.com/about/>About</a></li><li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded" href=https://wimpysworld.com/live/>Live</a></li><li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded" href=https://wimpysworld.com/posts/>Posts</a></li><li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded" href=https://wimpysworld.com/projects/>Projects</a></li></ul><form class="form-inline mx-4 my-0" action=/search method=get><div class=input-group><input class=form-control type=search name=q id=search-query placeholder=Search>
<button class="btn btn-primary btn-sm" id=searchButton type=submit><span class="fas fa-search"></span></button></div></form></div></div></nav><header class="masthead2 text-white text-center"></header><div class="container pb-1"><div class=row><section class="page-section portfolio col-12 col-lg-10"><img class="card-img-top img-fluid rounded mt-4" src=https://wimpysworld.com/posts/creating-production-ready-containers-advanced-techniques/hero.webp width=1280 height=720 alt="Advanced techniques for production-ready container best practice" loading=lazy><div class="page-section-heading text-center text-secondary mt-3"><b>Advanced techniques for production-ready container best practice</b></div><div class="divider-custom m-1"><div class=divider-custom-line></div><div class="divider-custom-icon text-secondary"><em class="fas fa-file-text"></em></div><div class=divider-custom-line></div></div><div class="row mb-2"><div class="col text-center text-nowrap"><a class=h4 href=/tags/alpine/ title=Alpine><span class="badge bg-primary p-2 m-1">Alpine</span></a>
<a class=h4 href=/tags/buildpacks/ title=Buildpacks><span class="badge bg-primary p-2 m-1">Buildpacks</span></a>
<a class=h4 href=/tags/devops/ title=DevOps><span class="badge bg-primary p-2 m-1">DevOps</span></a>
<a class=h4 href=/tags/distroless/ title=Distroless><span class="badge bg-primary p-2 m-1">Distroless</span></a>
<a class=h4 href=/tags/docker/ title=Docker><span class="badge bg-primary p-2 m-1">Docker</span></a>
<a class=h4 href=/tags/docker-compose/ title="Docker Compose"><span class="badge bg-primary p-2 m-1">Docker Compose</span></a>
<a class=h4 href=/tags/docker-slim/ title=docker-slim><span class="badge bg-primary p-2 m-1">docker-slim</span></a>
<a class=h4 href=/tags/multi-stage-builds/ title="Multi-Stage Builds"><span class="badge bg-primary p-2 m-1">Multi-Stage Builds</span></a>
<a class=h4 href=/tags/slimtoolkit/ title=SlimToolKit><span class="badge bg-primary p-2 m-1">SlimToolKit</span></a></div></div><div class="row justify-content-left"><div class=col-12><div class="alert alert-info" role=alert><h4 class=alert-heading>Update detected! <em class="fa-solid fa-spray-can-sparkles"></em></h4><p>This post is roughly 60 months old. Originally published on June 18, 2021 and last updated on April 28, 2023.</p></div></div><p>Creating production-ready containers for use in commercial-grade apps can be a far cry from the &ldquo;get started with Node.js and Docker&rdquo;-type of tutorials that are common around the Internet. Those guides are great for introducing all the advantages of Docker containers in modern cloud-native development, but creating a container that passes muster in a large-scale application in production is a different story.</p><p>For production-ready containers, there are three key things you want to optimise for when creating a container:</p><ol><li>Image Size üì¶</li><li>Build Speed üê¢</li><li>Security üîê</li></ol><p>Image size and build speed ensure that your containers can move through CI/CD and test pipelines easily and efficiently. Security is critical in today&rsquo;s software supply chain, and containers have their own set of security issues. Thankfully, reducing container image size actually can alleviate some security issues in containers.</p><p><a href=/posts/creating-production-ready-containers-the-basics>In my Basics article</a>, I showed you some easy techniques to improve your <code>Dockerfile</code> using a sample &ldquo;Hello World&rdquo; Node.js application.</p><p>These basics address all three optimisations, though they only scratch the surface.</p><p>Let&rsquo;s look at some more advanced techniques for Container Optimisation.</p><h2 id=alpine-images>Alpine Images</h2><p>The very first thing you&rsquo;ll encounter when looking for techniques to create smaller containers is <a href=https://alpinelinux.org/>Alpine Linux</a>. Alpine Linux is an open-source project whose goal is to create a bare-bones ü¶¥ version of Linux that lets developers &ldquo;build from the ground up.&rdquo;</p><h3 id=pros-transitioning-to-alpine-can-be-an-easy-way-to-get-a-smaller-container>Pros: Transitioning to Alpine can be an easy way to get a smaller container</h3><p>Reducing image size with Alpine can be incredibly simple - under the right circumstances. For some apps, it&rsquo;s as easy as changing the base image in your <code>Dockerfile</code>:</p><h4 id=from>FROM</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:red>FROM</span><span style=color:#87ceeb> node:16.2.0</span>
</span></span></code></pre></div><h4 id=to>TO</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:red>FROM</span><span style=color:#87ceeb> node:16.2.0-alpine</span>
</span></span></code></pre></div><p>When we build the new image, we see that the old image was 856MB and the new one is 114MB üéâ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>REPOSITORY         	TAG    	IMAGE ID        CREATED     	SIZE
</span></span><span style=display:flex><span>cotw-node-alpine    latest 	2cc7b4a7b09c    2 minutes ago   114MB
</span></span><span style=display:flex><span>cotw-node           latest 	873fb9fca53a    3 days ago  	856MB
</span></span></code></pre></div><p>Easy, right? Not so fast.</p><h3 id=cons-using-alpine-images-can-lead-to-build-problems-now-and-in-the-future>Cons: Using Alpine images can lead to build problems, now and in the future</h3><p>There are some not-so-obvious gotchas with using Alpine images that don&rsquo;t crop up in our super simple example application, such as:</p><h4 id=you-have-to-install-everything>You have to install everything</h4><p>Those tiny base images have to sacrifice something, right? Alpine users will be installing everything they need, right down to time-zone data or development tools. You won&rsquo;t need your development tools for your production image, most likely, but for most developers, the thought of a server without <code>curl</code> or <code>vim</code> is a bridge too far.</p><h4 id=different-compilers-and-package-managers>Different compilers and package managers</h4><p>You&rsquo;ll also be installing any dependencies with the Alpine Package Keeper tool (<code>apk</code>) instead of the more familiar <code>apt</code> or <code>rpm</code>. The differences are small but can trip up unsuspecting developers.</p><h4 id=fewer-examples-less-documentation>Fewer examples; less documentation</h4><p>Finally, while Alpine has been around for nine-plus years, it is and likely always will be a smaller and more specialised user base than established Linux distributions such as Ubuntu and Debian. To wit, at the time of this writing the <code>alpine</code> tag on StackOverflow has just <a href=https://stackoverflow.com/questions/tagged/alpine>1,280 questions</a>, compared with <a href=https://stackoverflow.com/questions/tagged/ubuntu>over 54,000 for Ubuntu</a>.</p><h2 id=multi-stage-builds>Multi-stage builds</h2><p>The next tactic you are likely to encounter when searching for ways to reduce Docker image sizes is multi-stage üèó builds. This tactic, <a href=https://docs.docker.com/develop/develop-images/multistage-build/>recommended by Docker and many in the Docker community</a>, is essentially building the image twice. The first set of commands builds your base application image, all things included. The second set of commands builds an image off of that base image, taking only what&rsquo;s needed and leaving out anything that&rsquo;s not.</p><p>With a multi-stage build, our <code>Dockerfile</code> would look like this. Notice the two <code>FROM</code> statements. The first builds the application image; the second copies the necessary files from that image into the second, more production-ready version.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:red>FROM</span><span style=color:#87ceeb> node:16.2.0-alpine as builder</span>
</span></span><span style=display:flex><span><span style=color:red>WORKDIR</span><span style=color:#87ceeb> /usr/src/app</span>
</span></span><span style=display:flex><span><span style=color:red>COPY</span> package*.json ./
</span></span><span style=display:flex><span><span style=color:red>RUN</span> npm ci
</span></span><span style=display:flex><span><span style=color:red>COPY</span> app.js ./
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:red>FROM</span><span style=color:#87ceeb> node:16.2.0-alpine</span>
</span></span><span style=display:flex><span><span style=color:red>WORKDIR</span><span style=color:#87ceeb> /usr/src/app</span>
</span></span><span style=display:flex><span><span style=color:red>COPY</span> --from=builder /usr/src/app .
</span></span><span style=display:flex><span><span style=color:red>EXPOSE</span><span style=color:#87ceeb> 3000</span>
</span></span><span style=display:flex><span><span style=color:red>USER</span><span style=color:#87ceeb> node</span>
</span></span><span style=display:flex><span><span style=color:red>CMD</span> [<span style=color:#87ceeb>&#34;node&#34;</span>,<span style=color:#87ceeb>&#34;app.js&#34;</span>]
</span></span></code></pre></div><h3 id=pros-dev-and-prod-images-can-be-built-separately>Pros: Dev and Prod images can be built separately</h3><p>When combined with <a href=https://docs.docker.com/compose/>Docker Compose</a>, this approach gives developers a flexible development environment while reducing bloat in the production images. You can simply use your initial image for dev/test and the final version for production. Multi-stage builds work especially well for Go containers, significantly reducing image size, but also work well for static Node.js and React-type applications.</p><h3 id=cons-added-complexity-use-case-specific>Cons: Added complexity; use-case specific</h3><p>Multi-stage builds are still relatively new üå± on the scene. For most developers still new to containers, knowing what to copy over to the final production image and what to leave behind is a major barrier to entry. Further, this pattern can run into challenges.</p><p>Since we&rsquo;re already using an Alpine image, the size savings are relatively minor for our &ldquo;Hello World&rdquo; example. You&rsquo;d expect to see greater gains in a full-blown React or Vue application.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>REPOSITORY            TAG     IMAGE ID   	CREATED        SIZE
</span></span><span style=display:flex><span>cotw-node-multistage  latest  52bc33d14a87  3 minutes ago  114MB
</span></span><span style=display:flex><span>cotw-node-alpine      latest  2cc7b4a7b09c  4 days ago     114MB
</span></span><span style=display:flex><span>cotw-node             latest  873fb9fca53a  7 days ago     856MB
</span></span></code></pre></div><h2 id=development-tools-and-distroless>Development tools and Distroless</h2><p>There are several tools - and new ones emerging every day - that look to bypass or automate <code>Dockerfile</code> authoring to make image creation easier. <a href=https://buildpacks.io/><em>Buildpacks</em></a> are the most mature of these technologies and can be used through tools like <a href=https://buildpacks.io/docs/tools/pack/>Pack</a> or <a href=https://www.waypointproject.io/plugins/pack>Waypoint</a>.</p><p>There are builder options from multiple sources - Heroku, Google, and Paketo are common favourites - and each gives you a slightly different developer experience and final image when used.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pack build cotw-node-bp-google --builder gcr.io/buildpacks/builder:v1
</span></span><span style=display:flex><span>$ pack build cotw-node-bp-heroku --builder heroku/buildpacks:18
</span></span><span style=display:flex><span>$ pack build cotw-node-bp-pb-base --builder paketobuildpacks/builder:base
</span></span><span style=display:flex><span>$ pack build cotw-node-bp-pb-full --builder paketobuildpacks/builder:full
</span></span></code></pre></div><h3 id=pros-when-they-work-they-work>Pros: When they work, they work</h3><p>In certain instances, Buildpacks can take the pain out of <code>Dockerfile</code> authoring and just create container images of your application with no fuss. The pack tool is looking for &ldquo;app-like&rdquo; files in your source directory, and automatically figuring out what kind of application is there and how to containerize it. In the case of our Node sample, it sees <code>package.json</code> and correctly assumes we have a Node.js application.</p><h3 id=cons-when-they-dont>Cons: When they don&rsquo;t‚Ä¶</h3><p>Given the relative newness of this approach for Docker containers, there are a lot of gotchas with Buildpacks. Non-standard applications or operating systems can struggle, and we&rsquo;ve had issues running them successfully on the new Silicon Macbook Pros. The resulting images vary a lot - we saw a range of 200MB to 800MB in our examples - and the results tend to be lower than what you&rsquo;d get with other techniques.</p><h2 id=automate-it-with-slimtoolkit>Automate it with SlimToolKit</h2><p>The <a href=https://slimtoolkit.org/>SlimToolKit</a> (<em>formerly DockerSlim</em>) open-source project was created by <a href=https://slim.ai>Slim.AI</a> CTO <a href=https://twitter.com/kcqon>Kyle Quest</a> in 2015 as a way to automate container optimisation. Simply download and run <code>slim build &lt;myimage></code> and SlimToolKit will examine the image, rebuild it with only the required dependencies, and give you a new image that can be run just like the original.</p><h3 id=pros-its-automatic>Pros: It&rsquo;s automatic</h3><p>SlimToolKit means you can work with whatever base image you&rsquo;d like (say, Ubuntu or Debian) and let SlimToolKit worry about removing unnecessary tools and files en route to production. The best part is that SlimToolKit can be used alongside any of these other techniques. Once tested, it can be integrated into your CI/CD pipeline for automatic container minification, and the reduction in size leads to faster build times and better security.</p><h3 id=cons-steep-learning-curve>Cons: Steep learning curve</h3><p>As with any open-source software, SlimToolKit can take some time to get working, especially for non-trivial applications. It works best for web-style applications, micro-services and APIs that have defined HTTP/HTTPS ports which the sensor can find and use to observe the container internals.</p><p>For best results, spend some time getting to know the various command flags available to tune your image, and <a href=https://github.com/slimtoolkit/examples>take a look at the examples for whatever framework you&rsquo;re using</a>.</p><h2 id=connecting-with-slimtoolkit>Connecting with SlimToolKit</h2><p>There&rsquo;s an <a href=https://discord.gg/uBttmfyYNB>active Slim.AI Discord channel</a> full of experts who can help you triage issues as they arise.</p><div class="col-5 mt-2 mb-2 text-left"><a class="btn btn-primary btn-lg col-12" href=https://wimpysworld.com/posts/why-i-chose-the-thinkpad-z13-as-my-linux-laptop/ aria-label="Why I chose the ThinkPad Z13 Gen1 as my Linux laptop"><span class=h2><em class="fa fa-chevron-circle-left"></em></span></a></div><div class="col-2 text-center"></div><div class="col-5 mt-2 mb-2 text-right"><a class="btn btn-primary btn-lg col-12" href=https://wimpysworld.com/posts/creating-production-ready-containers-the-basics/ aria-label="Creating Production-Ready Containers - The Basics"><span class=h2><em class="fa fa-chevron-circle-right"></em></span></a></div><script src=https://giscus.app/client.js data-repo=flexiondotorg/flexiondotorg.github.io data-repo-id=R_kgDOIoJw9g data-category="Blog Comments" data-category-id=DIC_kwDOIoJw9s4CTG_3 data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang crossorigin=anonymous async></script></div></section><section class="page-section portfolio col-12 col-lg-2 my-3"><div id=sidebar class=fixed><div class="widget pt-2"><h4 class="mb-1 widget-title text-secondary">Latest Posts</h4><ul class=list-unstyled><li class="d-flex my-1"><a href=https://wimpysworld.com/posts/steambox-vs-steamdeck/><h5>Steam Box vs Steam Deck</h5></a></li><li class="d-flex my-1"><a href=https://wimpysworld.com/posts/flash-stadia-controller-bluetooth-firmware-on-linux/><h5>Flash Stadia Controller Bluetooth Firmware on Linux</h5></a></li><li class="d-flex my-1"><a href=https://wimpysworld.com/posts/why-i-chose-the-thinkpad-z13-as-my-linux-laptop/><h5>Why I chose the ThinkPad Z13 Gen1 as my Linux laptop</h5></a></li></ul></div><div class="widget pt-2"><h4 class="mb-1 widget-title text-secondary">Related Posts</h4><ul class=list-unstyled><li class="d-flex my-1"><a href=https://wimpysworld.com/posts/creating-production-ready-containers-the-basics/><h5>Creating Production-Ready Containers - The Basics</h5></a></li></ul></div></div></section></div></div><footer class="footer text-center"><div class=container><div class=row><div class="col-lg-4 mb-5 mb-lg-0"><h3 class="text-uppercase mb-2">Social</h3><a class="btn btn-outline-light btn-social mx-1" href=https://wimpysworld.io/discord aria-label=Discord target=_blank rel="noopener noreferrer"><em class="fab fa-fw fa-discord"></em></a>
<a class="btn btn-outline-light btn-social mx-1" href=https://fosstodon.org/@wimpy aria-label=Mastodon target=_blank rel="noopener noreferrer"><em class="fab fa-fw fa-mastodon"></em></a>
<a class="btn btn-outline-light btn-social mx-1" href=https://twitter.com/m_wimpress aria-label=Twitter target=_blank rel="noopener noreferrer"><em class="fab fa-fw fa-twitter"></em></a>
<a class="btn btn-outline-light btn-social mx-1" href=https://linkedin.com/in/martinwimpress aria-label=LinkedIn target=_blank rel="noopener noreferrer"><em class="fab fa-fw fa-linkedin"></em></a></div><div class="col-lg-4 mb-5 mb-lg-0"><h3 class="text-uppercase mb-2">Code</h3><a class="btn btn-outline-light btn-social mx-1" href=https://github.com/flexiondotorg aria-label=GitHub target=_blank rel="noopener noreferrer"><em class="fab fa-fw fa-github"></em></a>
<a class="btn btn-outline-light btn-social mx-1" href=https://launchpad.net/~flexiondotorg aria-label=Launchpad target=_blank rel="noopener noreferrer"><em class="fab fa-fw fa-ubuntu"></em></a></div><div class=col-lg-4><h3 class="text-uppercase mb-2">Content</h3><a class="btn btn-outline-light btn-social mx-1" href=https://instagram.com/WimpysWorld aria-label=Instagram target=_blank rel="noopener noreferrer"><em class="fab fa-fw fa-instagram"></em></a>
<a class="btn btn-outline-light btn-social mx-1" href=https://twitch.tv/WimpysWorld aria-label=Twitch target=_blank rel="noopener noreferrer"><em class="fab fa-fw fa-twitch"></em></a>
<a class="btn btn-outline-light btn-social mx-1" href=https://youtube.com/WimpysWorld aria-label=YouTube target=_blank rel="noopener noreferrer"><em class="fab fa-fw fa-youtube"></em></a>
<a class="btn btn-outline-light btn-social mx-1" href=https://linuxmatters.sh aria-label=Podcast target=_blank rel="noopener noreferrer"><em class="fas fa-fw fa-podcast"></em></a></div></div></div></footer><div class="copyright py-4 text-center text-white"><div class=container><small>Copyright &copy; Martin Wimpress 2023</small></div></div><script defer src=https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.min.js integrity="sha512-OvBgP9A2JBgiRad/mM36mkzXSXaJE9BEIENnVEmeZdITvwT09xnxLtT4twkCa8m/loMbPHsvPl0T8lRGVBwjlQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script defer src=/js/scripts.js></script></body></html>